# ============================================================
# Cursor shape (zsh vi-mode)
# - Insert mode: bar
# - Normal mode: block
#
# Requirements:
# - bindkey -v (enabled in 06_keybindings.conf)
# - Terminal supports DECSCUSR (most xterm-compatible terminals do)
# ============================================================

# Skip if zle isn't available (non-interactive shells)
[[ -o interactive ]] || return

autoload -Uz add-zle-hook-widget

# Emit DECSCUSR cursor-shape sequences.
# 2 = steady block, 6 = steady bar (beam)
__cursor_block() { print -n -- $'\e[2 q' }
__cursor_bar()   { print -n -- $'\e[6 q' }

# Some terminals reset cursor shape on prompt redraw; re-assert on each keymap change.
function zle-keymap-select {
  case ${KEYMAP:-main} in
    vicmd) __cursor_block ;;
    viins|main) __cursor_bar ;;
    *) __cursor_bar ;;
  esac
  zle reset-prompt
}

function zle-line-init {
  __cursor_bar
  zle reset-prompt
}

function zle-line-finish {
  # Ensure a sane cursor when leaving zle (e.g. executing a command)
  __cursor_bar
}

zle -N zle-keymap-select
zle -N zle-line-init
zle -N zle-line-finish

# NOTE:
# zle-keymap-select / zle-line-init / zle-line-finish are *hook points*.
# After `zle -N <name>`, the widget itself is the handler, so hooking a hook to itself is invalid.
# (It triggers: "Cannot hook zle-keymap-select to itself".)
# If you later want multiple handlers, define separate widgets and hook those.
