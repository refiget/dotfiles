# ============================================================
# Fix: prevent recursive _stop_application_mode / FUNCNEST overflow
#
# Symptom:
#   _stop_application_mode:3: maximum nested function level reached; increase FUNCNEST?
#
# Cause:
#   In some reload orders, zle-line-finish can end up pointing to a function
#   that references itself recursively.
#
# Strategy:
#   Force zle-line-init / zle-line-finish to simple, non-recursive widgets.
# ============================================================
[[ -o interactive ]] || return

zmodload -F zsh/terminfo +p:terminfo +b:echoti 2>/dev/null || return
(( ${+terminfo[smkx]} && ${+terminfo[rmkx]} )) || return

# Clean up potentially broken wrappers from framework/plugin reloads.
unfunction _start_application_mode 2>/dev/null
unfunction _stop_application_mode 2>/dev/null

__zle_appmode_start() { echoti smkx }
__zle_appmode_stop()  { echoti rmkx }

zle -N zle-line-init __zle_appmode_start
zle -N zle-line-finish __zle_appmode_stop
