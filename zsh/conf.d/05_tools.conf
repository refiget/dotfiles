# ============================================================
# External tools: yazi / zoxide / fzf / nvm / atuin
# ============================================================

# yazi: quit后自动cd到最后目录
y() {
  local tmp cwd
  tmp="$(mktemp -t yazi-cwd.XXXXXX)" || return
  command yazi --cwd-file="$tmp" "$@"
  [[ -s "$tmp" ]] && cwd="$(<"$tmp")"
  rm -f -- "$tmp"
  [[ -n "${cwd:-}" && "$cwd" != "$PWD" ]] && builtin cd -- "$cwd"
}

# zoxide + fzf
if command -v zoxide >/dev/null 2>&1; then
  export _ZO_FZF_OPTS=${_ZO_FZF_OPTS:-'--height=40% --layout=reverse --border=rounded --border-label=" zoxide " --margin=1 --padding=1 --prompt=" " --pointer="▌" --info=inline-right --no-separator --cycle --no-scrollbar --bind=tab:down,ctrl-i:down,btab:up'}

  eval "$(zoxide init zsh)"

  # z => 交互选择, Z => 原始快速跳转
  if (( $+functions[z] )); then
    __zoxide_z_swapped() { __zoxide_z "$@"; }
    z() { zi "$@"; }
    Z() { __zoxide_z_swapped "$@"; }
  fi

  alias za='zoxide add $(pwd)'
  alias zl='zoxide query -l'
  alias zf='zoxide query'
fi

# fzf
[[ -f ~/.fzf.zsh ]] && source ~/.fzf.zsh
[[ -f /usr/share/doc/fzf/examples/key-bindings.zsh ]] && source /usr/share/doc/fzf/examples/key-bindings.zsh
[[ -f /usr/share/doc/fzf/examples/completion.zsh ]] && source /usr/share/doc/fzf/examples/completion.zsh

export FZF_IGNORE_FILE="$HOME/.ignore"
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --strip-cwd-prefix --ignore-file "$FZF_IGNORE_FILE" --exclude .git'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --strip-cwd-prefix --ignore-file "$FZF_IGNORE_FILE" --exclude .git'

# lazy nvm
export NVM_DIR="$HOME/.nvm"
lazy_nvm() {
  unset -f node npm nvm
  [[ -s "$NVM_DIR/nvm.sh" ]] && source "$NVM_DIR/nvm.sh"
}
node() { lazy_nvm; node "$@"; }
npm() { lazy_nvm; npm "$@"; }
nvm() { lazy_nvm; nvm "$@"; }

# atuin
if command -v atuin >/dev/null 2>&1; then
  eval "$(atuin init zsh --disable-up-arrow)"
fi
