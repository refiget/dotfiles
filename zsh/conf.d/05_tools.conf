# ============================================================
# External Tools (Yazi, Zoxide, FZF, NVM)
# ============================================================

# Yazi
y() {
  local tmp
  tmp="$(mktemp)" || return
  trap 'rm -f "$tmp"' RETURN

  yazi --cwd-file="$tmp" "$@"

  # Only cd when yazi wrote a non-empty path
  if [[ -s "$tmp" ]]; then
    cd -- "$(cat "$tmp")" || return
  fi
}

# Zoxide
# - Beautified interactive picker via fzf
# - Swap z/Z: prefer `z` for interactive (like Telescope), keep fast-jump as `Z`
if command -v zoxide >/dev/null 2>&1; then
  # Minimal chrome, reverse list, inline info. Tweak freely.
  # Telescope-ish fzf UI: prompt on top, minimal chrome, no scrollbar
  # Telescope-ish fzf UI (used by zoxide, incl. Yazi's zoxide plugin): prompt on top, rounded border, minimal chrome
  # Start with our preferred defaults if the user hasn't set anything
  export _ZO_FZF_OPTS=${_ZO_FZF_OPTS:-'--height=40% --layout=reverse --border=rounded --border-label=" zoxide " --margin=1 --padding=1 --prompt=" " --pointer="▌" --info=inline-right --no-separator --cycle --no-scrollbar'}

  # Ensure Tab works inside fzf (some terminals send Tab as Ctrl-I)
  case " $_ZO_FZF_OPTS " in
    *" --bind="*) : ;;
    *) _ZO_FZF_OPTS="$_ZO_FZF_OPTS --bind=tab:down,ctrl-i:down,btab:up" ;;
  esac
  export _ZO_FZF_OPTS

  eval "$(zoxide init zsh)"

  # Swap: z => interactive, Z => original z behavior
  if (( $+functions[z] )); then
    __zoxide_z_swapped() { __zoxide_z "$@"; }
    z() { zi "$@"; }
    Z() { __zoxide_z_swapped "$@"; }
  fi

  alias za='zoxide add $(pwd)'
  alias zl='zoxide query -l'
  alias zf='zoxide query'
fi

# FZF
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
[ -f /usr/share/doc/fzf/examples/key-bindings.zsh ] && source /usr/share/doc/fzf/examples/key-bindings.zsh
[ -f /usr/share/doc/fzf/examples/completion.zsh ] && source /usr/share/doc/fzf/examples/completion.zsh
export FZF_IGNORE_FILE="$HOME/.ignore"
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --strip-cwd-prefix --ignore-file "$FZF_IGNORE_FILE" --exclude .git'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --strip-cwd-prefix --ignore-file "$FZF_IGNORE_FILE" --exclude .git'

# Lazy NVM
export NVM_DIR="$HOME/.nvm"
lazy_nvm() {
  unset -f node npm nvm
  [[ -s "$NVM_DIR/nvm.sh" ]] && source "$NVM_DIR/nvm.sh"
}
node() { lazy_nvm; node "$@"; }
npm() { lazy_nvm; npm "$@"; }
nvm() { lazy_nvm; nvm "$@"; }

# direnv removed (auto-activation disabled by choice)

# atuin (better shell history). Only enable when installed.
if command -v atuin >/dev/null 2>&1; then
  eval "$(atuin init zsh --disable-up-arrow)"
fi
